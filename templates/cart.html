{% extends 'base.html' %}
{% load static %}
{% block hero %}{% endblock hero %}
{% block content %}
<section class="h-100 h-custom" style="padding-top: 100px; background-color: #AC142C;">
    <div class="container py-5 h-100">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col">
                <div class="card">
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-lg-7">
                                <h5 class="mb-3"><a href="#!" class="text-body"><i class="fas fa-long-arrow-alt-left me-2"></i>Continue shopping</a></h5>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <p class="mb-1">Shopping cart</p>
                                        <p class="mb-0">You have {{cart.count}} items in your cart</p>
                                    </div>
                                    <div>
                                        <p class="mb-0"><span class="text-muted">Sort by:</span> <a href="#!" class="text-body">price <i class="fas fa-angle-down mt-1"></i></a></p>
                                    </div>
                                </div>
                                
                            <!-- Add a class 'cart-item' to each card and a unique id 'cart-item-1', 'cart-item-2', etc. -->
                            {% for cartItem in cartItems %}
                            <div class="card mb-3 cart-item" id="cart-item-1">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex flex-row align-items-center">
                                            <img src="{{cartItem.product.product_image.url}}" class="img-fluid rounded-3" alt="Shopping item" style="width: 65px;">
                                            <div class="ms-3">
                                                <h5>{{cartItem.product.product_name}}</h5>
                                                <p class="small mb-0">{{cartItem.product.product_desc}}</p>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-row align-items-center">
                                            <form action="update_cart_quantity/" method="POST">
                                            {% csrf_token %}
                                                <input name="quantity" type="number" value="{{cartItem.quantity}}" min="1" style="width: 50px;">
                                            </form>
                                            <h5 class="mb-0 item-price"> ${{cartItem.product.product_price}}</h5>
                                            <a href="#!" style="color: #AC142C;"><i class="fas fa-trash-alt"></i></a>
                                        </div>
                                    </div>    
                                </div>
                            </div>            
                            {% endfor %}  
                            <div class="col-lg-5">
                            <div class="card shadow-lg">
                                <div class="card-body">
                                <h5>Cart total</h5>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <p>Subtotal</p>
                                    <p id="subtotal">$</p>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p>Shipping</p>
                                    <p>$50</p>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <p>Total</p>
                                    <h5 id="total">$</h5>
                                </div>
                                {% comment %} <a href="{% url 'credit_card' total=0 %}?total_amount={{ total|floatformat:2 }}" id="chec kout-btn" class="btn btn-primary w-100 mt-4" style="background-color: #AC142C; border-color: #AC142C;">Checkout</a> {% endcomment %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</section>
                <script>
                    {% comment %} $(document).ready(function() {
                    $('.quantity-input').on('change', function() {
                        const $item = $(this).closest('.cart-item');
                        const cartId = $item.attr('id').substring(9); // Remove 'cart-item-' prefix
                        const itemPrice = parseFloat($item.find('.item-price').text().substring(1));
                        const quantity = parseInt($(this).val());
                    
                        // Update the total price immediately before the AJAX request
                        updateTotal();
                    
                        // Send AJAX request to update cart quantity in the backend
                        $.ajax({
                        url: '{% url "update_cart_quantity" %}',
                        type: 'POST',
                        data: {
                            'cart_id': cartId,
                            'quantity': quantity,
                            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                            // No need to call updateTotal() here, as it was called before the AJAX request
                            } else {
                            // Handle failure case
                            console.error('Failed to update cart quantity');
                            }
                        },
                        error: function() {
                            // Handle error case
                            console.error('Error updating cart quantity');
                        }
                        });
                    });
                    
                    function updateTotal() {
                        let subtotal = 0;
                    
                        $('.cart-item').each(function() {
                        const quantity = parseInt($(this).find('.quantity-input').val());
                        const itemPrice = parseFloat($(this).find('.item-price').text().substring(1));
                        subtotal += quantity * itemPrice;
                        });
                    
                        const shipping = 50;
                        const total = subtotal + shipping;
                    
                        $('#subtotal').text(`$${subtotal.toFixed(2)}`);
                        $('#total').text(`$${total.toFixed(2)}`);
                    
                        // Update the "Checkout" button href to include the total amount
                        $('#checkout-btn').attr('href', `{% url 'credit_card' total=0 %}?total_amount=${total.toFixed(2)}`);
                    }
                    });
                    {% endcomment %}
                </script>
{% endblock content %}